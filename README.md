# C3 Distributed Branch
Before starting anything, make sure to change PROJECT_EXT in `./cloudlab/nodes.sh` to match the name of YOUR cloudlab project in which you created this job

## Installation
1. Create a cloudlab job with 17 nodes (16 nodes for actors, 1 node for learner) using the `orca` profile (which will have the `linux-learner` image preinstalled once the nodes start)'
2. Run `./cloudlab/config.sh` to setup the nodes (run this from YOUR machine).
3. The next thing you will have to do is `./cloudlab/setup_params.sh` to generate `rl-module/params_distributed.json`. (run this on node0 on cloudlab)
4. Once this is done, you should use `v9_multi_train.sh` to start the training job - do this within a `tmux` session. (run this on cloudlab node0)
5. `ssh` into the actor nodes and look at `~/actor_logs/` to see the `stdout` (and `stderr`) of each actors. Look inside `~/ConstrainedOrca/rl-module/training_log` for the train log.
6. Once training is done,  use `scripts/collate_train_files.sh` to collect everything into one place. Backup the folder generated by this for the future.

## Eval
1. Move the checkpoint you desire into `~/ConstrainedOrca/rl-module/train_dir/seed0/`. When you do `ls` inside this `seed0`, it should show you one directory that looks something like `learner0-v9_actorNum256_multi_lambda0.0_ksymbolic5_k1_raw-sym_threshold25_seed0/`.
2. Run `./scripts/eval_orca.sh <model_name> <trace_dir> <results_dir> <start_run> <end_run> <constraints_id>`.
3. `<trace_dir>` is for SAGE traces. In Cloudlab, we used `/proj/verifiedmlsys-PG0/ConstrainedOrca/sage_traces/traces`.
4. `<results_dir>` is for saving results. We used `/proj/verifiedmlsys-PG0/sigcomm_results/new_result_dir/constraint_id_*`.

## Real-world 
0. Orca/C3/TCP sender is on Cloudlab. Receiver is on Azure. 
1. On Cloudlab node, create a `~/.ssh/config` file which contains all of the nodes in Azure (e.g. australia, etc)
2. Install `mahimahi` on all Azure nodes from source:
```bash
# from http://mahimahi.mit.edu/#getting
sudo apt-get update
sudo apt-get install autotools-dev dh-autoreconf iptables pkg-config dnsmasq-base apache2-dev apache2-bin debhelper libssl-dev ssl-cert libxcb-present-dev libcairo2-dev libpango1.0-dev protobuf-compiler libprotobuf-dev unzip
git clone https://github.com/ravinet/mahimahi
cd mahimahi
./autogen.sh
./configure
make
sudo make install
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Copy over `~/ConstrainedOrca` (distributed) onto all Azure nodes and build it using `build_v2.sh`

## Plotting and analysis
0. Use `cd scripts && ./process_down_file.sh` to trim stuff.
1. Use `./scripts/plots/plot_thr.py` for motivation figures
2. Use `./scripts/plots/plot_thr_delay.py` for thr vs delay plots.

## Other useful info
1. `baseline_v4` is the baseline used for NSDI submission.